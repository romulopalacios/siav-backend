# üöÄ SIAV Backend - Supabase Edition# SIAV Backend - MQTT Bridge to Supabase PostgreSQL



Sistema de backend para **SIAV** (Sistema Inteligente de Anal√≠tica Vial) que funciona como puente MQTT ‚Üí Supabase PostgreSQL.Backend Node.js que act√∫a como puente entre el broker MQTT y Supabase (PostgreSQL).



## üìã Caracter√≠sticas## üéØ Funcionalidades



- ‚úÖ **MQTT Bridge**: Recibe eventos de dispositivos IoT v√≠a MQTT- ‚úÖ **MQTT Bridge**: Suscribe al broker MQTT y guarda eventos en PostgreSQL

- ‚úÖ **Supabase PostgreSQL**: Almacenamiento persistente escalable- ‚úÖ **Detecci√≥n de Infracciones**: Registra infracciones autom√°ticamente

- ‚úÖ **API REST**: Endpoints para consultar estad√≠sticas y eventos- ‚úÖ **API REST**: Endpoints para consultas y reportes

- ‚úÖ **Validaci√≥n de datos**: Integridad completa de velocidad, direcci√≥n y ubicaci√≥n- ‚úÖ **Reportes Diarios**: Generaci√≥n de anal√≠tica agregada

- ‚úÖ **Cach√© inteligente**: Reduce carga en DB con TTL configurable- ‚úÖ **Health Check**: Monitoreo del estado del servidor

- ‚úÖ **Detecci√≥n de infracciones**: Registro autom√°tico de excesos de velocidad- ‚úÖ **Cach√© Inteligente**: Reduce lecturas de base de datos

- ‚úÖ **Alta Disponibilidad**: Sin l√≠mites de cuota

## üõ†Ô∏è Stack Tecnol√≥gico

## üìã Requisitos

- **Node.js 18+**

- **Express 5.1.0**- Node.js 18+ 

- **Supabase Client 2.39.0**- Cuenta Supabase (plan gratuito)

- **MQTT 5.14.1**- Broker MQTT (test.mosquitto.org por defecto)

- **PostgreSQL** (via Supabase)

## üöÄ Instalaci√≥n

## üì¶ Instalaci√≥n Local

```bash

```bash# Instalar dependencias

# Instalar dependenciasnpm install

npm install

# O si usas el workspace root

# Configurar variables de entornocd backend

cp .env.example .envnpm install

# Editar .env con tus credenciales```



# Iniciar servidor## ‚öôÔ∏è Configuraci√≥n

npm start

```### 1. Crear proyecto Supabase



## üîß Variables de Entorno Requeridas1. Ve a https://supabase.com

2. Crea una cuenta (usa GitHub)

```env3. Crea un nuevo proyecto: `siav-deteccion-velocidad`

# Supabase Configuration4. Elige regi√≥n: `South America (S√£o Paulo)`

SUPABASE_URL=https://tu-proyecto.supabase.co5. Espera ~2 minutos

SUPABASE_SERVICE_KEY=tu-service-role-key-aqui

### 2. Ejecutar Schema SQL

# MQTT Configuration

MQTT_BROKER=mqtt://test.mosquitto.org:18831. En Supabase, ve a **SQL Editor**

MQTT_TOPIC=siav/eventos/test2. Crea un **New query**

3. Copia y pega el contenido de `supabase-schema.sql`

# Server Configuration4. Haz clic en **Run** (‚ñ∂Ô∏è)

PORT=30005. Verifica: ‚úÖ "Schema creado exitosamente"

NODE_ENV=production

```### 3. Obtener Credenciales



## üöÇ Deploy en Railway1. Ve a **Settings** ‚Üí **API**

2. Copia:

### Opci√≥n 1: Desde GitHub (Recomendado)   - **Project URL** ‚Üí `SUPABASE_URL`

   - **anon/public key** ‚Üí `SUPABASE_ANON_KEY`

1. **Sube el c√≥digo a GitHub:**   - **service_role key** ‚Üí `SUPABASE_SERVICE_KEY`

```bash

git add .### 4. Configurar variables de entorno

git commit -m "Preparado para Railway deployment"

git push origin mainCrea/edita el archivo `.env`:

```

```env

2. **Conecta con Railway:**# Supabase

   - Ve a [railway.app](https://railway.app)SUPABASE_URL=https://tuproyecto.supabase.co

   - Click en **"New Project"** ‚Üí **"Deploy from GitHub repo"**SUPABASE_ANON_KEY=tu-anon-key-aqui

   - Selecciona tu repositorio `siav-backend`SUPABASE_SERVICE_KEY=tu-service-role-key-aqui



3. **Configura Variables de Entorno:**# MQTT

   - En Railway Dashboard ‚Üí tu proyecto ‚Üí **Variables**MQTT_BROKER=mqtt://test.mosquitto.org:1883

   - Agrega todas las variables del archivo `.env`:MQTT_TOPIC=siav/eventos/test

     ```

     SUPABASE_URL=https://iagocycfidhjylitjbhj.supabase.co# Server

     SUPABASE_SERVICE_KEY=tu-service-keyPORT=3000

     MQTT_BROKER=mqtt://test.mosquitto.org:1883NODE_ENV=development

     MQTT_TOPIC=siav/eventos/test```

     PORT=3000

     NODE_ENV=production## üèÉ Ejecuci√≥n

     ```

### Modo Desarrollo (con auto-reload)

4. **Deploy autom√°tico:**```bash

   - Railway detectar√° `railway.json` y `Procfile`npm run dev

   - El deploy se iniciar√° autom√°ticamente```

   - Obtendr√°s una URL p√∫blica: `https://tu-proyecto.up.railway.app`

### Modo Producci√≥n

### Opci√≥n 2: Railway CLI```bash

npm start

```bash```

# Instalar Railway CLI

npm i -g @railway/cli## üì° API Endpoints



# Login| M√©todo | Endpoint | Descripci√≥n |

railway login|--------|----------|-------------|

| GET | `/` | Health check y estado del servidor |

# Inicializar proyecto| GET | `/stats` | Estad√≠sticas globales (con cach√© de 30s) |

railway init| GET | `/eventos/recientes?limit=10` | √öltimos N eventos |

| GET | `/generar-reporte?fecha=2025-01-15` | Generar reporte para fecha espec√≠fica |

# Deploy| GET | `/reportes?limit=30` | Obtener √∫ltimos reportes hist√≥ricos |

railway up| GET | `/api/eventos?limit=100` | Eventos (formato dashboard) |

```| GET | `/api/estadisticas` | Estad√≠sticas (formato dashboard) |

| GET | `/api/graficos` | Datos para gr√°ficos (√∫ltimas 12h) |

## üîç Verificar Deploy

### Ejemplos de uso

Despu√©s del deploy, verifica estos endpoints:

```bash

- **Health Check**: `https://tu-proyecto.up.railway.app/`# Health check

- **Estad√≠sticas**: `https://tu-proyecto.up.railway.app/stats`curl http://localhost:3000/

- **Eventos recientes**: `https://tu-proyecto.up.railway.app/eventos/recientes`

- **API Dashboard**: `https://tu-proyecto.up.railway.app/api/estadisticas`# Estad√≠sticas (con cach√©)

curl http://localhost:3000/stats

## üì° Endpoints API

# √öltimos 5 eventos

### Informaci√≥n Generalcurl http://localhost:3000/eventos/recientes?limit=5

- `GET /` - Health check y estado del servidor

- `GET /stats` - Estad√≠sticas generales del sistema# Generar reporte de hoy

curl http://localhost:3000/generar-reporte

### Eventos

- `GET /eventos/recientes` - √öltimos 50 eventos registrados# Dashboard - estad√≠sticas

- `GET /api/eventos` - Lista paginada de eventoscurl http://localhost:3000/api/estadisticas



### Estad√≠sticas# Dashboard - gr√°ficos

- `GET /api/estadisticas` - Estad√≠sticas para dashboardcurl http://localhost:3000/api/graficos

- `GET /api/graficos` - Datos para gr√°ficos```



### Reportes## üóÑÔ∏è Estructura de Base de Datos (PostgreSQL)

- `POST /generar-reporte` - Genera reporte diario

- `GET /reportes` - Lista de reportes generados### Tabla: `eventos_trafico`

```sql

## üß™ Testingid                  BIGSERIAL PRIMARY KEY

dispositivo_id      VARCHAR(100) NOT NULL

### Test local con curl:velocidad           NUMERIC(6,2) NOT NULL

```bashdireccion           VARCHAR(10) NOT NULL

curl http://localhost:3000/es_infraccion       BOOLEAN DEFAULT false

curl http://localhost:3000/statstimestamp           TIMESTAMPTZ NOT NULL

```ubicacion           JSONB

limite_velocidad    INTEGER DEFAULT 50

### Test en Railway:procesado           BOOLEAN DEFAULT false

```bashrecibido_en         TIMESTAMPTZ DEFAULT NOW()

curl https://tu-proyecto.up.railway.app/stats```

```

### Tabla: `infracciones`

## üìä Estructura de Base de Datos```sql

id                  BIGSERIAL PRIMARY KEY

### Tabla: `eventos_trafico`evento_id           BIGINT REFERENCES eventos_trafico(id)

- Almacena todas las detecciones de veh√≠culosvelocidad           NUMERIC(6,2) NOT NULL

- Campos: `id`, `dispositivo_id`, `velocidad`, `direccion`, `es_infraccion`, `timestamp`, `ubicacion`, etc.direccion           VARCHAR(10) NOT NULL

ubicacion           JSONB

### Tabla: `infracciones`dispositivo_id      VARCHAR(100) NOT NULL

- Registro espec√≠fico de infracciones de velocidadtimestamp           TIMESTAMPTZ NOT NULL

- Referencia a `eventos_trafico` con foreign keylimite_velocidad    INTEGER DEFAULT 50

notificada          BOOLEAN DEFAULT false

### Tabla: `reportes_diarios`creado_en           TIMESTAMPTZ DEFAULT NOW()

- Res√∫menes agregados por fecha```

- Incluye promedios, m√°ximos, m√≠nimos y porcentajes

### Tabla: `reportes_diarios`

## üîê Seguridad```sql

id                          BIGSERIAL PRIMARY KEY

- ‚úÖ Variables de entorno nunca en c√≥digofecha                       DATE NOT NULL UNIQUE

- ‚úÖ `.env` en `.gitignore`total_detecciones           INTEGER DEFAULT 0

- ‚úÖ Service role key solo en variables de Railwaytotal_infracciones          INTEGER DEFAULT 0

- ‚úÖ CORS configurado para producci√≥nporcentaje_infracciones     NUMERIC(5,2)

- ‚úÖ RLS (Row Level Security) habilitado en Supabasevelocidad_promedio          NUMERIC(6,2)

velocidad_maxima            NUMERIC(6,2)

## üêõ Troubleshootingvelocidad_minima            NUMERIC(6,2)

direcciones                 JSONB

### El servidor no inicia en Railway:generado_en                 TIMESTAMPTZ DEFAULT NOW()

1. Verifica que `PORT` est√© en variables de entorno (Railway lo asigna autom√°ticamente)```

2. Revisa los logs: Railway Dashboard ‚Üí Deployments ‚Üí View Logs

3. Verifica que `SUPABASE_URL` y `SUPABASE_SERVICE_KEY` est√©n correctos## üöÄ Ventajas vs Firebase



### No recibe eventos MQTT:| Caracter√≠stica | Firebase | Supabase |

1. Verifica la URL del broker MQTT|----------------|----------|----------|

2. Confirma que el topic sea el mismo en publisher y backend| **Lecturas/d√≠a** | 50,000 (limitado) | Ilimitadas* |

3. Revisa los logs para ver si hay conexi√≥n al broker| **Escrituras/d√≠a** | 20,000 (limitado) | Ilimitadas* |

| **Base de datos** | NoSQL | PostgreSQL |

### Errores de base de datos:| **Queries** | Limitadas | SQL completo |

1. Verifica que las tablas est√©n creadas en Supabase SQL Editor| **Agregaciones** | No nativas | Nativas (SUM, AVG, etc) |

2. Confirma que el `SUPABASE_SERVICE_KEY` tenga permisos de escritura| **Escalabilidad** | Costosa | Econ√≥mica |

3. Revisa las pol√≠ticas RLS en Supabase Dashboard| **Open Source** | No | S√≠ |



## üìù Logs en Railway_*Limitado por recursos del servidor, no por operaciones_



Accede desde:## üß™ Probar el Sistema

- Railway Dashboard ‚Üí tu proyecto ‚Üí Deployments ‚Üí View Logs

- O usa Railway CLI: `railway logs`### Terminal 1: Iniciar Backend

```bash

## üéØ Monitoreonpm start

```

Railway proporciona:

- üìä M√©tricas de CPU y MemoriaDeber√≠as ver:

- üîÑ Auto-restart en caso de fallos```

- üìà Gr√°ficos de uso de recursosüöÄ SIAV Backend Server v2.0.0 (Supabase Edition)

- üö® Healthcheck autom√°tico‚úÖ Supabase: Connected

‚úÖ MQTT Broker: Connected

## üìÑ Licencia‚úÖ Database: Supabase PostgreSQL

```

ISC

### Terminal 2: Publicar eventos de prueba

## üë• Autor```bash

cd ../hardware/simulator

SIAV Team - Sistema Inteligente de Anal√≠tica Vialpython publisher.py --count 10

```

---

Ver√°s los eventos llegando al backend y guard√°ndose en Supabase.

**¬øProblemas con el deployment?** Revisa los logs en Railway Dashboard o verifica las variables de entorno.

## üêõ Troubleshooting

### Error: "SUPABASE_URL is required"
**Soluci√≥n:** Configura las variables en `.env` (ver paso 3-4 de Configuraci√≥n)

### Error: "Table does not exist"
**Soluci√≥n:** Ejecuta el script `supabase-schema.sql` en el SQL Editor de Supabase

### Error: "Permission denied"
**Soluci√≥n:** Verifica que uses `SUPABASE_SERVICE_KEY` en lugar de `SUPABASE_ANON_KEY`

### Error: "MQTT Connection error"
**Soluci√≥n:** Verifica que el broker MQTT est√© accesible. Prueba con `test.mosquitto.org`

## üì¶ Despliegue en Railway.app

1. Sube tu c√≥digo a GitHub
2. Conecta Railway.app con tu repo
3. Agrega las variables de entorno en Railway:
   - `SUPABASE_URL`
   - `SUPABASE_SERVICE_KEY`
   - `MQTT_BROKER`
   - `MQTT_TOPIC`
4. Railway detectar√° autom√°ticamente Node.js y desplegar√°

## üìù Notas Importantes

- ‚úÖ **Cach√© de 30s** en estad√≠sticas (reduce lecturas)
- ‚úÖ **Fallback a memoria** si Supabase falla
- ‚úÖ **Row Level Security (RLS)** habilitado
- ‚úÖ **√çndices optimizados** para consultas r√°pidas
- ‚úÖ **Vista materializada** para estad√≠sticas en tiempo real
- ‚úÖ QoS 1 en MQTT para garantizar entrega

## üîÑ Migraci√≥n desde Firebase

Si tienes datos en Firebase, consulta `MIGRACION-SUPABASE.md` para:
1. Exportar datos de Firebase
2. Importar a Supabase
3. Verificar integridad

---

**Proyecto:** SIAV - Sistema Inteligente de Anal√≠tica Vial  
**Versi√≥n:** 2.0.0 (Supabase Edition)  
**Base de Datos:** PostgreSQL (Supabase)  
**Arquitectura:** MQTT Bridge + REST API
